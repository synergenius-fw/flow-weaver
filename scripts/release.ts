#!/usr/bin/env tsx
/**
 * Release script — bump version, push, merge, tag, and create GitHub release.
 *
 * Usage:
 *   npm run release patch       # 0.2.1 → 0.2.2
 *   npm run release minor       # 0.2.1 → 0.3.0
 *   npm run release major       # 0.2.1 → 1.0.0
 *   npm run release 0.5.0       # explicit version
 *
 * What it does:
 *   1. Bumps version in package.json
 *   2. Creates a release branch, commits, pushes
 *   3. Creates and merges a PR (squash)
 *   4. Tags the merge commit and creates a GitHub release with auto-generated notes
 */

import * as fs from 'fs';
import * as path from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.resolve(__dirname, '..');
const pkgPath = path.join(rootDir, 'package.json');

// ── Helpers ──────────────────────────────────────────────────────────

function run(cmd: string, opts?: { cwd?: string; stdio?: 'inherit' | 'pipe' }): string {
  return execSync(cmd, {
    cwd: opts?.cwd ?? rootDir,
    stdio: opts?.stdio ?? 'pipe',
    encoding: 'utf-8',
  }).trim();
}

function fail(msg: string): never {
  console.error(`\x1b[31m✗ ${msg}\x1b[0m`);
  process.exit(1);
}

function info(msg: string): void {
  console.log(`\x1b[36m→ ${msg}\x1b[0m`);
}

function success(msg: string): void {
  console.log(`\x1b[32m✓ ${msg}\x1b[0m`);
}

// ── Version bumping ──────────────────────────────────────────────────

function bumpVersion(current: string, bump: string): string {
  // Explicit version
  if (/^\d+\.\d+\.\d+/.test(bump)) return bump;

  const [major, minor, patch] = current.split('.').map(Number);
  switch (bump) {
    case 'patch':
      return `${major}.${minor}.${patch + 1}`;
    case 'minor':
      return `${major}.${minor + 1}.0`;
    case 'major':
      return `${major + 1}.0.0`;
    default:
      fail(`Invalid bump type: "${bump}". Use patch, minor, major, or an explicit version.`);
  }
}

// ── Generate release notes from commits since last tag ───────────────

function generateReleaseNotes(lastTag: string): string {
  let commits: string;
  try {
    commits = run(`git log ${lastTag}..HEAD --oneline --no-merges`);
  } catch {
    commits = run('git log --oneline --no-merges -20');
  }

  if (!commits.trim()) return 'Maintenance release.';

  const lines = commits
    .split('\n')
    .map((line) => {
      // Strip commit hash, keep message
      const msg = line.replace(/^[a-f0-9]+ /, '');
      return `- ${msg}`;
    });

  return `### Changes\n\n${lines.join('\n')}`;
}

// ── Pre-flight checks ────────────────────────────────────────────────

function preflight(): void {
  // Must be on main
  const branch = run('git rev-parse --abbrev-ref HEAD');
  if (branch !== 'main') {
    fail(`Must be on main branch (currently on "${branch}")`);
  }

  // Must be clean (allow untracked)
  const dirty = run('git diff --name-only');
  if (dirty) {
    fail(`Working tree has uncommitted changes:\n${dirty}\nCommit or stash them first.`);
  }

  // Must be up to date with remote
  run('git fetch origin main');
  const behind = run('git rev-list HEAD..origin/main --count');
  if (behind !== '0') {
    fail(`Local main is ${behind} commit(s) behind origin. Run "git pull" first.`);
  }

  // gh CLI must be available
  try {
    run('gh --version');
  } catch {
    fail('GitHub CLI (gh) is required but not found. Install it: https://cli.github.com');
  }
}

// ── Main ─────────────────────────────────────────────────────────────

const bump = process.argv[2];
if (!bump) {
  console.log('Usage: npm run release <patch|minor|major|x.y.z>');
  process.exit(0);
}

preflight();

// Read current version
const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf-8'));
const currentVersion = pkg.version;
const newVersion = bumpVersion(currentVersion, bump);
const tag = `v${newVersion}`;
const releaseBranch = `release/${tag}`;

info(`Bumping ${currentVersion} → ${newVersion}`);

// Check tag doesn't already exist
try {
  run(`git rev-parse ${tag}`);
  fail(`Tag ${tag} already exists`);
} catch {
  // Good — tag doesn't exist
}

// 1. Bump version
pkg.version = newVersion;
fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2) + '\n');
success(`Updated package.json to ${newVersion}`);

// 2. Create release branch, commit, push
run(`git checkout -b ${releaseBranch}`);
run('git add package.json');
run(`git commit -m "Release ${tag}"`);
run(`git push -u origin ${releaseBranch}`);
success(`Pushed ${releaseBranch}`);

// 3. Create and merge PR
const prUrl = run(
  `gh pr create --title "Release ${tag}" --body "Bump version to ${newVersion}" --base main --head ${releaseBranch}`
);
info(`PR created: ${prUrl}`);

// Wait a moment for CI to register, then merge
info('Merging PR...');
try {
  run(`gh pr merge ${releaseBranch} --squash --subject "Release ${tag}" --body "Bump version to ${newVersion}" --admin`);
} catch {
  // If --admin fails (no admin rights), try auto-merge
  info('Admin merge failed, setting auto-merge...');
  run(`gh pr merge ${releaseBranch} --squash --subject "Release ${tag}" --body "Bump version to ${newVersion}" --auto`);
  console.log('\nAuto-merge enabled. The release will complete once CI passes.');
  console.log(`After merge, run: gh release create ${tag} --target main --title "${tag}" --generate-notes`);
  process.exit(0);
}

success('PR merged');

// 4. Pull the merge commit and tag it
run('git checkout main');
run('git pull origin main');

// 5. Create GitHub release with auto-generated notes
const lastTag = run('git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo ""');
const notes = generateReleaseNotes(lastTag || '');

const notesFile = path.join(rootDir, '.release-notes.tmp');
fs.writeFileSync(notesFile, notes);
try {
  run(`gh release create ${tag} --target main --title "${tag}" --notes-file ${notesFile}`);
} finally {
  fs.unlinkSync(notesFile);
}
success(`Release ${tag} published!`);

// Cleanup: delete release branch
try {
  run(`git branch -d ${releaseBranch}`);
  run(`git push origin --delete ${releaseBranch}`);
} catch {
  // Non-critical
}
